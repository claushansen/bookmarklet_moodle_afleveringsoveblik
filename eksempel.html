<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Elevstatistik Bookmarklet</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 0 20px;
      background-color: #f9f9f9;
      color: #333;
    }
    h1 {
      color: #0056b3;
    }
    p {
      line-height: 1.6;
    }
    .bookmarklet {
      display: inline-block;
      margin-top: 20px;
      padding: 10px 20px;
      background: #0056b3;
      color: #fff;
      text-decoration: none;
      border-radius: 4px;
      font-weight: bold;
      cursor: pointer;
    }
    .bookmarklet:hover {
      background: #003d80;
    }
    .info {
      font-size: 0.9em;
      color: #555;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>Elevstatistik Bookmarklet</h1>
  <p>Denne bookmarklet udtrækker data om elevers opgaver fra en Moodle-brugerliste-side.</p>
  <p>Når bookmarkleten aktiveres, vil den:</p>
  <ul>
    <li>Skrolle til toppen af siden.</li>
    <li>Hente data for de elever, der er markeret (checkede) i Moodle-brugerlisten.</li>
    <li>Udtrække antallet af opgaver, antallet af afleverede opgaver og beregne en afleveringsprocent.</li>
    <li>Vise et overskueligt UI med elevkort, diagram og detaljeret statistik.</li>
    <li>Give mulighed for at downloade data for den enkelte elev eller for alle elever samlet som en Excel-fil.</li>
  </ul>
  <p>For at bruge bookmarkleten skal du blot trække knappen nedenfor til din bogmærkelinje. Når du herefter besøger en Moodle-brugerliste-side, klik på bookmarkleten for at køre scriptet.</p>
  <a class="bookmarklet" href="javascript:(function()%7Bfunction%20s2ab(s)%7Bvar%20buf%3Dnew%20ArrayBuffer(s.length)%3Bvar%20view%3Dnew%20Uint8Array(buf)%3Bfor(var%20i%3D0%3Bi%3Cs.length%3Bi%2B%2B)view%5Bi%5D%3Ds.charCodeAt(i)%26%200xFF%3Breturn%20buf%7D%3B%2F*Scrol%20to%20top%20*%2Fwindow.scrollTo(%7Btop%3A0%2Cbehavior%3A%22smooth%22%7D)%3Bvar%20googlescript%3Ddocument.createElement(%22script%22)%3Bgooglescript.type%3D%22text%2Fjavascript%22%2Cgooglescript.src%3D%22https%3A%2F%2Fwww.gstatic.com%2Fcharts%2Floader.js%22%2C%24(%22head%22).append(googlescript)%3Bvar%20filesavescript%3Ddocument.createElement(%22script%22)%3Bfilesavescript.type%3D%22text%2Fjavascript%22%2Cfilesavescript.src%3D%22https%3A%2F%2Fcdnjs.cloudflare.com%2Fajax%2Flibs%2FFileSaver.js%2F1.3.8%2FFileSaver.min.js%22%2C%24(%22head%22).append(filesavescript)%2Crequire.config(%7Bpaths%3A%7Bxlsx%3A%22https%3A%2F%2Fcdn.jsdelivr.net%2Fgh%2Fsheetjs%2Fsheetjs%2Fdist%2Fxlsx.full.min%22%7D%7D)%2Crequire(%5B%22xlsx%22%5D%2Cfunction(e)%7Bconsole.log(%22SheetJS%20loaded..%22)%7D)%2CsetTimeout(function()%7Bvar%20e%3D%24(%22%23participants%20tbody%20tr%3Anot(.emptyrow)%22).has(%22input.usercheckbox%3Achecked%22).length%3Bif(0%3D%3D%3De)return%20void%20alert(%22Du%20skal%20v%C3%A6lge%20mindst%20%C3%A9n%20elev%20f%C3%B8r%20du%20kan%20k%C3%B8re%20statistikken!%22)%3Bgoogle.charts.load(%22current%22%2C%7Bpackages%3A%5B%22corechart%22%5D%7D)%3Bvar%20t%3D'%3Cdiv%20id%3D%22elevstatWrapper%22%20class%3D%22shadow%20p-3%20mb-5%20bg-dark%20rounded%20%22%20style%3D%22z-index%3A%201000%3B%20%22%3E%3Cdiv%20class%3D%22row%20text-light%20p-3%22%3E%3Ch4%20class%3D%22text-white%22%3EElevstatistik%20overblik%3C%2Fh4%3E%3Cdiv%20class%3D%22spinner-border%20mx-auto%22%20role%3D%22status%22%3E%3C%2Fdiv%3E%3Cdiv%20class%3D%22dropdown%20ml-auto%22%3E%3Cbutton%20class%3D%22elevstat-download-all%20btn%20btn-light%20dropdown-toggle%22%20type%3D%22button%22%20data-toggle%3D%22dropdown%22%20disabled%3E%3Ci%20class%3D%22fa%20fa-download%22%3E%3C%2Fi%3E%20Download%20alle%3C%2Fbutton%3E%3Cdiv%20class%3D%22dropdown-menu%20download-all-menu%22%3E%3Ca%20class%3D%22dropdown-item%20download-all-excel%22%20href%3D%22%23%22%3E%3Ci%20class%3D%22fa%20fa-file-excel-o%22%3E%3C%2Fi%3E%20Excel%20(.xlsx)%3C%2Fa%3E%3Ca%20class%3D%22dropdown-item%20download-all-csv%22%20href%3D%22%23%22%3E%3Ci%20class%3D%22fa%20fa-file-text-o%22%3E%3C%2Fi%3E%20CSV%20(.csv)%3C%2Fa%3E%3Ca%20class%3D%22dropdown-item%20download-all-json%22%20href%3D%22%23%22%3E%3Ci%20class%3D%22fa%20fa-file-code-o%22%3E%3C%2Fi%3E%20JSON%20(.json)%3C%2Fa%3E%3C%2Fdiv%3E%3C%2Fdiv%3E%3Cbutton%20id%3D%22elevstatCloseButton%22%20class%3D%22btn%20btn-danger%20text-white%20ml-2%22%20aria-label%3D%22luk%20elevstatistik%22%20data-toggle%3D%22tooltip%22%20data-placement%3D%22top%22%20title%3D%22Luk%20statistikken%22%20disabled%3E%3Ci%20class%3D%22fa%20fa-times-circle%22%3E%3C%2Fi%3E%20Afslut%3C%2Fbutton%3E%3C%2Fdiv%3E%3Cdiv%20id%3D%22elevstatCards%22%20class%3D%22row%22%3E%3C!--Elevcards--%3E%3C%2Fdiv%3E%3C%2Fdiv%3E'%3B%24(%22div%23page%22).prepend(t)%2C%24(%22body%22).append('%3Cdiv%20id%3D%22loadelevpage%22%20class%3D%22invisible%22%3E%3C%2Fdiv%3E')%3Bvar%20a%3D%24(%22%23participants%20tbody%20tr%3Anot(.emptyrow)%22).has(%22input.usercheckbox%3Achecked%22).find(%22th.c1%22)%3Bfor(i%3D0%3Bi%3Ca.length%3Bi%2B%2B)%7Bvar%20n%3D%24(a%5Bi%5D).find(%22a%22).attr(%22href%22)%2Cr%3Dnew%20URL(n)%2Cs%3Dnew%20window.URLSearchParams(r.search)%2Cl%3Ds.get(%22id%22)%2Co%3Ds.get(%22course%22)%2Cd%3Da.length%3B%24(%22%23loadelevpage%22).load(%22%2Freport%2Foutline%2Fuser.php%3Fid%3D%22%2Bl%2B%22%26course%3D%22%2Bo%2B%22%26mode%3Dcomplete%20%23region-main-box%22%2Cfunction()%7Bvar%20e%3D%24(%22%23loadelevpage%20.page-header-headings%20h2%22).text()%2Ct%3D%24(%22%23loadelevpage%20%23message-user-button%22).data(%22userid%22)%2Ca%3D%5B%5D%3B%24(%22%23loadelevpage%20.section%22).each(function()%7Bvar%20e%3D%24(this).find(%22h2%22).first().text()%3B%24(this).find(%22.submissionstatustable%22).parent(%22ul%22).prev(%22h4%22).each(function(t)%7Blet%20n%3D%7B%7D%3Bn.emne%3De%2Cn.titel%3D%24(this).text()%2Cn.afleveret%3D%24(this).next(%22ul%22).find(%22.submissionstatussubmitted%22).length%3C1%3F%22Nej%22%3A%22Ja%22%2Ca.push(n)%7D)%7D)%3Bvar%20n%3Da.length%2Cr%3Da.filter(e%3D%3E%22Ja%22%3D%3D%3De.afleveret).length%2Cs%3DMath.floor(r%2Fn*100)%3BlocalStorage.setItem(%22elevstat-%22%2Bt%2CJSON.stringify(a))%3Bfor(var%20l%3D%22%22%2Co%3D0%3Bo%3Ca.length%3Bo%2B%2B)%7Blet%20e%3D%22Ja%22%3D%3Da%5Bo%5D.afleveret%3F%22badge-success%22%3A%22badge-warning%22%3Bl%2B%3D%60%3Cli%20class%3D%22list-group-item%20d-flex%20justify-content-between%20align-items-center%22%3E%24%7Ba%5Bo%5D.titel%7D%3Cspan%20class%3D%22badge%20%24%7Be%7D%20badge-pill%22%3E%24%7Ba%5Bo%5D.afleveret%7D%3C%2Fspan%3E%3C%2Fli%3E%60%7Dvar%20i%3D%60%3Cdiv%20class%3D%22col-12%20col-sm-6%20col-md-4%20mt-2%22%3E%3Cdiv%20id%3D%22elevcard-%24%7Bt%7D%22%20class%3D%22elevcard%20card%20bg-white%20border%20rounded%22%3E%3Cdiv%20class%3D%22card-header%22%3E%24%7Be%7D%3C%2Fdiv%3E%3Cdiv%20id%3D%22chart-%24%7Bt%7D%22%3E%3Cspan%20class%3D%22sr-only%22%3ELoading...%3C%2Fspan%3E%3C%2Fdiv%3E%3Cdiv%20class%3D%22card-body%22%3E%3Cdiv%20class%3D%22d-flex%20justify-content-end%20align-items-center%22%3E%3Cbutton%20class%3D%22show-details%20btn%20btn-secondary%20mr-2%22%20type%3D%22button%22%20data-toggle%3D%22collapse%22%20data-userid%3D%22%24%7Bt%7D%22%20data-target%3D%22%23elevstatDetaljer-%24%7Bt%7D%22%20aria-expanded%3D%22false%22%20aria-controls%3D%22elevstatDetaljer-%24%7Bt%7D%22%20disabled%3E%3Ci%20class%3D%22fa%20fa-spinner%20fa-spin%22%3E%3C%2Fi%3E%20Henter%20Data%3C%2Fbutton%3E%3Cdiv%20class%3D%22btn-group%22%3E%3Cbutton%20class%3D%22elevstat-download%20btn%20btn-secondary%20dropdown-toggle%22%20type%3D%22button%22%20data-toggle%3D%22dropdown%22%20data-userid%3D%22%24%7Bt%7D%22%20data-user%3D%22%24%7Be%7D%22%20disabled%3E%3Ci%20class%3D%22fa%20fa-download%22%3E%3C%2Fi%3E%3C%2Fbutton%3E%3Cdiv%20class%3D%22dropdown-menu%22%3E%3Ca%20class%3D%22dropdown-item%20download-excel%22%20href%3D%22%23%22%3E%3Ci%20class%3D%22fa%20fa-file-excel-o%22%3E%3C%2Fi%3E%20Excel%3C%2Fa%3E%3Ca%20class%3D%22dropdown-item%20download-csv%22%20href%3D%22%23%22%3E%3Ci%20class%3D%22fa%20fa-file-text-o%22%3E%3C%2Fi%3E%20CSV%3C%2Fa%3E%3Ca%20class%3D%22dropdown-item%20download-json%22%20href%3D%22%23%22%3E%3Ci%20class%3D%22fa%20fa-file-code-o%22%3E%3C%2Fi%3E%20JSON%3C%2Fa%3E%3C%2Fdiv%3E%3C%2Fdiv%3E%3C%2Fdiv%3E%3Cdiv%20class%3D%22collapse%20mt-3%22%20id%3D%22elevstatDetaljer-%24%7Bt%7D%22%3E%3Cp%20class%3D%22card-text%22%3E%24%7Be%7D%20har%20afleveret%20%24%7Br%7D%20ud%20af%20%24%7Bn%7D%20og%20har%20derfor%20en%20afleveringsprocent%20p%C3%A5%20%24%7Bs%7D%25.%3C%2Fp%3E%3Cul%20class%3D%22list-group%22%3E%24%7Bl%7D%3C%2Ful%3E%3C%2Fdiv%3E%3C%2Fdiv%3E%3C%2Fdiv%3E%3C%2Fdiv%3E%60%3B%24(%22%23elevstatCards%22).append(i)%3Bvar%20c%3Dgoogle.visualization.arrayToDataTable(%5B%5B%22Opgaver%22%2C%22Afleverede%22%5D%2C%5B%22Afleveret%22%2Cr%5D%2C%5B%22Ikke%20Afleveret%22%2Cn-r%5D%5D)%2Cv%3D%7Btitle%3A%22Afleveringer%22%2CbackgroundColor%3A%22%23f2f2f2%22%2Cwidth%3A%22auto%22%2Cheight%3A%22auto%22%2Clegend%3A%7Bposition%3A%22bottom%22%7D%7D%2Cp%3D%60chart-%24%7Bt%7D%60%2Ch%3Dnew%20google.visualization.PieChart(document.getElementById(p))%3Bh.draw(c%2Cv)%2C0%3D%3D--d%26%26(%24(%22.show-details%22).removeAttr(%22disabled%22)%2C%24(%22.elevstat-download-all%22).removeAttr(%22disabled%22)%2C%24(%22.elevstat-download%22).removeAttr(%22disabled%22)%2C%24(%22%23elevstatCloseButton%22).removeAttr(%22disabled%22)%2C%24(%22.show-details%22).text(%22Se%20Detaljer%22)%2C%24(%22.fa-spinner%22).remove()%2C%24(%22.spinner-border%22).remove()%2C%24(%22.show-details%22).click(function()%7Bvar%20e%3D%24(this)%3Be.text(%22Se%20Detaljer%22%3D%3De.text()%3F%22Skjul%20Detaljer%22%3A%22Se%20Detaljer%22)%7D)%2C%24(document).on(%22click%22%2C%22.elevcard%20.dropdown-item%22%2Cfunction(e)%7Be.preventDefault()%3Bconst%20t%3D%24(this).closest(%22.card-body%22).find(%22.elevstat-download%22)%2Ca%3Dt.data(%22userid%22)%2Cn%3Dt.data(%22user%22)%2Cr%3DJSON.parse(localStorage.getItem(%22elevstat-%22%2Ba))%3Bif(!r)return%20void%20alert(%22Ingen%20data%20fundet%20for%20denne%20elev%22)%3Bif(%24(this).hasClass(%22download-excel%22))%7Bvar%20s%3DXLSX.utils.book_new()%3Bs.Props%3D%7BTitle%3A%22Elev%20Statistik%22%2CSubject%3A%22Elevstatistik%22%2CAuthor%3A%22Claus%20Hansen%20-%20clh%40zbc.dk%22%2CCreatedDate%3Anew%20Date%7D%2Cs.SheetNames.push(%22Afleveringer%22)%3Bvar%20l%3D%5B%5B%22Emne%22%2C%22Opgave%22%2C%22Afleveret%22%5D%5D%3Br.forEach(e%3D%3El.push(%5Be.emne%2Ce.titel%2Ce.afleveret%5D))%3Bvar%20o%3DXLSX.utils.aoa_to_sheet(l)%3Bs.Sheets.Afleveringer%3Do%3Bvar%20i%3DXLSX.write(s%2C%7BbookType%3A%22xlsx%22%2Ctype%3A%22binary%22%7D)%3BsaveAs(new%20Blob(%5Bs2ab(i)%5D%2C%7Btype%3A%22application%2Foctet-stream%22%7D)%2C%22afleveringer-%22%2Bn%2B%22.xlsx%22)%7Delse%20if(%24(this).hasClass(%22download-csv%22))%7Blet%20e%3D%22Emne%2COpgave%2CAfleveret%5Cn%22%3Br.forEach(t%3D%3Ee%2B%3D%60%22%24%7Bt.emne%7D%22%2C%22%24%7Bt.titel%7D%22%2C%22%24%7Bt.afleveret%7D%22%5Cn%60)%3Bconst%20t%3Dnew%20Blob(%5Be%5D%2C%7Btype%3A%22text%2Fcsv%3Bcharset%3Dutf-8%3B%22%7D)%3BsaveAs(t%2C%22afleveringer-%22%2Bn%2B%22.csv%22)%7Delse%20if(%24(this).hasClass(%22download-json%22))%7Bconst%20e%3Dnew%20Blob(%5BJSON.stringify(r%2Cnull%2C2)%5D%2C%7Btype%3A%22application%2Fjson%22%7D)%3BsaveAs(e%2C%22afleveringer-%22%2Bn%2B%22.json%22)%7D%7D)%2C%24(document).on(%22click%22%2C%22.download-all-excel%22%2Cfunction(e)%7Be.preventDefault()%3Bvar%20t%3DXLSX.utils.book_new()%3Bt.Props%3D%7BTitle%3A%22Elev%20afleveringer%20Statistik%22%2CSubject%3A%22Elevstatistik%22%2CAuthor%3A%22Claus%20Hansen%20-%20clh%40zbc.dk%22%2CCreatedDate%3Anew%20Date%7D%2C%24(%22.elevstat-download%22).each(function(e)%7Bvar%20a%3D%24(this).data(%22userid%22)%2Cn%3D%24(this).data(%22user%22)%3Bn%3Dn.substring(0%2C30)%3Bvar%20r%3DJSON.parse(localStorage.getItem(%22elevstat-%22%2Ba))%3Bif(r)%7Bvar%20s%3D%5B%5B%22Emne%22%2C%22Opgave%22%2C%22Afleveret%22%5D%5D%3Br.forEach(e%3D%3Es.push(%5Be.emne%2Ce.titel%2Ce.afleveret%5D))%2Ct.SheetNames.push(n)%3Bvar%20l%3DXLSX.utils.aoa_to_sheet(s)%3Bt.Sheets%5Bn%5D%3Dl%7D%7D)%3Bvar%20a%3DXLSX.write(t%2C%7BbookType%3A%22xlsx%22%2Ctype%3A%22binary%22%7D)%3BsaveAs(new%20Blob(%5Bs2ab(a)%5D%2C%7Btype%3A%22application%2Foctet-stream%22%7D)%2C%22samlet-afleverings-statistik.xlsx%22)%7D)%2C%24(document).on(%22click%22%2C%22.download-all-csv%22%2Cfunction(e)%7Be.preventDefault()%3Blet%20t%3D%5B%5D%3B%24(%22.elevstat-download%22).each(function()%7Bconst%20e%3D%24(this).data(%22userid%22)%2Ca%3D%24(this).data(%22user%22)%2Cn%3DJSON.parse(localStorage.getItem(%22elevstat-%22%2Be))%3Bn%26%26n.forEach(e%3D%3Et.push(%5Ba%2Ce.emne%2Ce.titel%2Ce.afleveret%5D))%7D)%3Blet%20a%3D%22Elev%2CEmne%2COpgave%2CAfleveret%5Cn%22%3Bt.forEach(e%3D%3Ea%2B%3D%60%22%24%7Be%5B0%5D%7D%22%2C%22%24%7Be%5B1%5D%7D%22%2C%22%24%7Be%5B2%5D%7D%22%2C%22%24%7Be%5B3%5D%7D%22%5Cn%60)%3Bconst%20n%3Dnew%20Blob(%5Ba%5D%2C%7Btype%3A%22text%2Fcsv%3Bcharset%3Dutf-8%3B%22%7D)%3BsaveAs(n%2C%22samlet-afleverings-statistik.csv%22)%7D)%2C%24(document).on(%22click%22%2C%22.download-all-json%22%2Cfunction(e)%7Be.preventDefault()%3Blet%20t%3D%7B%7D%3B%24(%22.elevstat-download%22).each(function()%7Bconst%20e%3D%24(this).data(%22userid%22)%2Ca%3D%24(this).data(%22user%22)%2Cn%3DJSON.parse(localStorage.getItem(%22elevstat-%22%2Be))%3Bn%26%26(t%5Ba%5D%3Dn)%7D)%3Bconst%20a%3Dnew%20Blob(%5BJSON.stringify(t%2Cnull%2C2)%5D%2C%7Btype%3A%22application%2Fjson%22%7D)%3BsaveAs(a%2C%22samlet-afleverings-statistik.json%22)%7D)%2C%24(%22%23elevstatCloseButton%22).click(function()%7Bconfirm(%22Er%20du%20sikker%20p%C3%A5%20at%20du%20vil%20lukke%20statistikken%3F%22)%26%26(%24(%22.elevstat-download%22).each(function(e)%7Blet%20t%3D%24(this).data(%22userid%22)%3Bconsole.log(t)%2ClocalStorage.removeItem(%22elevstat-%22%2Bt)%7D)%2C%24(%22%23elevstatWrapper%22).remove()%2C%24(%22%23loadelevpage%22).remove()%2C%24(%22script%5Bsrc%3D'https%3A%2F%2Fwww.gstatic.com%2Fcharts%2Floader.js'%5D%22).remove()%2C%24(%22script%5Bsrc%3D'https%3A%2F%2Fcdnjs.cloudflare.com%2Fajax%2Flibs%2FFileSaver.js%2F1.3.8%2FFileSaver.min.js'%5D%22).remove()%2C%24(%22script%5Bsrc%3D'https%3A%2F%2Fcdn.jsdelivr.net%2Fgh%2Fsheetjs%2Fsheetjs%2Fdist%2Fxlsx.full.min.js'%5D%22).remove()%2C%24(%22script%5Bsrc%3D'https%3A%2F%2Fwww.gstatic.com%2Fcharts%2F51%2Floader.js'%5D%22).remove()%2C%24(%22script%5Bsrc%3D'https%3A%2F%2Fwww.gstatic.com%2Fcharts%2F51%2Fjs%2Fjsapi_compiled_default_module.js'%5D%22).remove()%2C%24(%22script%5Bsrc%3D'https%3A%2F%2Fwww.gstatic.com%2Fcharts%2F51%2Fjs%2Fjsapi_compiled_graphics_module.js'%5D%22).remove()%2C%24(%22script%5Bsrc%3D'https%3A%2F%2Fwww.gstatic.com%2Fcharts%2F51%2Fjs%2Fjsapi_compiled_ui_module.js'%5D%22).remove()%2C%24(%22script%5Bsrc%3D'https%3A%2F%2Fwww.gstatic.com%2Fcharts%2F51%2Fjs%2Fjsapi_compiled_corechart_module.js'%5D%22).remove()%2C%24(%22link%5Bhref%3D'https%3A%2F%2Fwww.gstatic.com%2Fcharts%2F51%2Fcss%2Fcore%2Ftooltip.css'%5D%22).remove()%2C%24(%22link%5Bhref%3D'https%3A%2F%2Fwww.gstatic.com%2Fcharts%2F51%2Fcss%2Futil%2Futil.css'%5D%22).remove())%7D))%7D)%7D%7D%2C1e3)%7D)();" title="Træk til bogmærkelinjen">Elevstatistik Bookmarklet</a>
  <p class="info">
    Træk knappen direkte til din bogmærkelinje.
  </p>
</body>
</html>
